<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh√≥a h·ªçc ƒë√£ ho√†n th√†nh - Video Learning Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .nav-buttons {
            padding: 20px 30px;
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .content {
            padding: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .courses-list {
            display: grid;
            gap: 20px;
        }
        
        .course-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }
        
        .course-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .course-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .course-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .badge-completed {
            background: #28a745;
            color: white;
        }
        
        .course-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 1.1em;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .grade-A {
            color: #28a745;
        }
        
        .grade-B {
            color: #17a2b8;
        }
        
        .grade-C {
            color: #ffc107;
        }
        
        .grade-D {
            color: #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .no-data-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Kh√≥a h·ªçc ƒë√£ ho√†n th√†nh</h1>
            <p>Video Learning Platform</p>
        </div>
        
        <div class="nav-buttons">
            <a href="index.html" class="btn btn-secondary">‚Üê Quay l·∫°i trang ch√≠nh</a>
            <button class="btn btn-primary" onclick="loadCompletedCourses()">üîÑ L√†m m·ªõi</button>
        </div>
        
        <div class="content">
            <div id="debugPanel" class="debug-panel">
                <div class="debug-title">üêõ DEBUG CONSOLE</div>
                <div id="debugLog"></div>
            </div>
            
            <div id="stats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCourses">0</div>
                    <div class="stat-label">Kh√≥a h·ªçc ho√†n th√†nh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgScore">0</div>
                    <div class="stat-label">ƒêi·ªÉm trung b√¨nh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTime">0h</div>
                    <div class="stat-label">T·ªïng th·ªùi gian h·ªçc</div>
                </div>
            </div>
            
            <div id="loading" class="loading">
                ‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="coursesList" class="courses-list"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const BACKEND_URL = 'http://localhost:3001';
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('student') || '690302badd7c9774cfd2a6a7';
        let PARTNER_API_KEY = null;
        let CONFIG = null;
        
        // ===== DEBUG UTILITIES =====
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString().substring(11, 19);
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            if (data) {
                console.log('Data:', data);
            }
            
            // Add to UI
            const debugLogDiv = document.getElementById('debugLog');
            const logElement = document.createElement('div');
            logElement.style.marginBottom = '5px';
            logElement.innerHTML = `<span style="color: #007bff;">${timestamp}</span> ${message}`;
            if (data) {
                logElement.innerHTML += `<br><span style="color: #6c757d; padding-left: 50px;">${JSON.stringify(data, null, 2).substring(0, 200)}</span>`;
            }
            debugLogDiv.appendChild(logElement);
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
        }
        
        function debugError(message, error) {
            const timestamp = new Date().toISOString().substring(11, 19);
            console.error(`[${timestamp}] ERROR: ${message}`);
            console.error('Error details:', error);
            
            // Add to UI
            const debugLogDiv = document.getElementById('debugLog');
            const logElement = document.createElement('div');
            logElement.style.marginBottom = '5px';
            logElement.style.color = '#dc3545';
            logElement.innerHTML = `<span style="font-weight: bold;">${timestamp} ‚ùå ERROR:</span> ${message}`;
            if (error.message) {
                logElement.innerHTML += `<br><span style="padding-left: 50px;">${error.message}</span>`;
            }
            debugLogDiv.appendChild(logElement);
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
        }
        
        // ===== LOAD CONFIGURATION =====
        async function loadConfig() {
            debugLog('üì• Loading partner configuration...');
            
            try {
                const response = await fetch('/config');
                debugLog(`Config response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                CONFIG = await response.json();
                PARTNER_API_KEY = CONFIG.apiKey;
                
                debugLog('‚úÖ Config loaded successfully', {
                    partnerId: CONFIG.partnerId,
                    partnerName: CONFIG.partnerName,
                    hasApiKey: !!PARTNER_API_KEY,
                    apiKeyPrefix: PARTNER_API_KEY ? PARTNER_API_KEY.substring(0, 10) + '...' : 'NONE'
                });
                
                if (!PARTNER_API_KEY) {
                    throw new Error('API Key not found in config');
                }
                
                return true;
            } catch (error) {
                debugError('Failed to load config', error);
                showError('Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh: ' + error.message);
                return false;
            }
        }
        
        // ===== LOAD COMPLETED COURSES =====
        async function loadCompletedCourses() {
            debugLog('=== üöÄ STARTING LOAD COMPLETED COURSES ===');
            debugLog(`Student ID: ${studentId}`);
            
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const coursesList = document.getElementById('coursesList');
            const stats = document.getElementById('stats');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            coursesList.innerHTML = '';
            stats.style.display = 'none';
            
            try {
                // Step 1: Load config if not loaded
                if (!PARTNER_API_KEY) {
                    debugLog('üîë Config not loaded, loading now...');
                    const configLoaded = await loadConfig();
                    if (!configLoaded) {
                        throw new Error('Failed to load configuration');
                    }
                } else {
                    debugLog(`üîë Using existing API Key: ${PARTNER_API_KEY.substring(0, 10)}...`);
                }
                
                // Step 2: Load completed courses
                debugLog('üìö Fetching completed courses...');
                const completedUrl = `${BACKEND_URL}/api/partner/public/completed-courses/user/${studentId}`;
                debugLog(`URL: ${completedUrl}`);
                debugLog(`API Key: ${PARTNER_API_KEY.substring(0, 10)}...`);
                
                const completedResponse = await fetch(completedUrl, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': PARTNER_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                debugLog(`Response status: ${completedResponse.status} ${completedResponse.statusText}`);
                
                if (!completedResponse.ok) {
                    const errorText = await completedResponse.text();
                    debugError(`API Error ${completedResponse.status}`, { body: errorText.substring(0, 300) });
                    throw new Error(`API Error ${completedResponse.status}: ${errorText.substring(0, 200)}`);
                }
                
                const completedData = await completedResponse.json();
                debugLog('‚úÖ Completed courses data received', {
                    success: completedData.success,
                    hasData: !!completedData.data,
                    hasCourses: !!(completedData.data && completedData.data.courses),
                    courseCount: completedData.data && completedData.data.courses ? completedData.data.courses.length : 0
                });
                
                // Step 3: Load enrollments for time data
                debugLog('üìã Fetching enrollments...');
                const enrollmentsUrl = `${BACKEND_URL}/api/partner/public/enrollment/student/${studentId}`;
                
                const enrollmentsResponse = await fetch(enrollmentsUrl, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': PARTNER_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                debugLog(`Enrollments response: ${enrollmentsResponse.status}`);
                
                let enrollmentsData = null;
                if (enrollmentsResponse.ok) {
                    enrollmentsData = await enrollmentsResponse.json();
                    debugLog('‚úÖ Enrollments data received', {
                        success: enrollmentsData.success,
                        enrollmentCount: enrollmentsData.data && enrollmentsData.data.enrollments ? enrollmentsData.data.enrollments.length : 0
                    });
                } else {
                    debugLog('‚ö†Ô∏è Failed to load enrollments, continuing without time data');
                }
                
                loading.style.display = 'none';
                
                // Step 4: Process and display data
                debugLog('üìä Processing course data...');
                
                if (!completedData.success) {
                    throw new Error('API returned success=false: ' + (completedData.message || 'Unknown error'));
                }
                
                if (!completedData.data || !completedData.data.courses) {
                    debugLog('‚ÑπÔ∏è No courses found in response');
                    showNoCourses();
                    return;
                }
                
                const courses = completedData.data.courses;
                debugLog(`‚úÖ Found ${courses.length} courses`);
                
                if (courses.length === 0) {
                    showNoCourses();
                    return;
                }
                
                // Get enrollments array
                const enrollments = enrollmentsData && enrollmentsData.data && enrollmentsData.data.enrollments 
                    ? enrollmentsData.data.enrollments 
                    : [];
                
                debugLog(`‚úÖ Found ${enrollments.length} enrollments`);
                
                // Display courses
                displayCourses(courses, enrollments);
                
                debugLog('=== ‚úÖ LOAD COMPLETED SUCCESSFULLY ===');
                
            } catch (err) {
                debugError('Error loading completed courses', err);
                loading.style.display = 'none';
                showError(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${err.message}`);
            }
        }
        
        // ===== DISPLAY FUNCTIONS =====
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
        }
        
        function showNoCourses() {
            const coursesList = document.getElementById('coursesList');
            coursesList.innerHTML = `
                <div class="no-data">
                    <div class="no-data-icon">üìö</div>
                    <h2>Ch∆∞a c√≥ kh√≥a h·ªçc n√†o ho√†n th√†nh</h2>
                    <p>H√£y b·∫Øt ƒë·∫ßu h·ªçc v√† ho√†n th√†nh c√°c kh√≥a h·ªçc ƒë·ªÉ xem th√†nh t√≠ch c·ªßa b·∫°n t·∫°i ƒë√¢y!</p>
                </div>
            `;
        }
        
        function displayCourses(courses, enrollments) {
            debugLog('üé® Displaying courses...');
            
            const coursesList = document.getElementById('coursesList');
            const stats = document.getElementById('stats');
            
            // Calculate stats
            const totalCourses = courses.length;
            const totalScore = courses.reduce((sum, course) => sum + (parseFloat(course.score) || 0), 0);
            const avgScore = totalCourses > 0 ? (totalScore / totalCourses).toFixed(1) : 0;
            
            let totalTimeMinutes = 0;
            enrollments.forEach(enrollment => {
                if (enrollment.timeSpentSeconds) {
                    totalTimeMinutes += Math.round(enrollment.timeSpentSeconds / 60);
                }
            });
            const totalTimeHours = (totalTimeMinutes / 60).toFixed(1);
            
            debugLog('üìà Stats calculated', {
                totalCourses,
                avgScore,
                totalTimeHours
            });
            
            // Display stats
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalTime').textContent = totalTimeHours + 'h';
            stats.style.display = 'grid';
            
            // Display courses
            coursesList.innerHTML = courses.map((course, index) => {
                debugLog(`Rendering course ${index + 1}: ${course.name}`);
                
                // Find matching enrollment for time data
                const enrollment = enrollments.find(e => e._id === course.enrollmentId);
                const timeSpent = enrollment && enrollment.timeSpentSeconds 
                    ? Math.round(enrollment.timeSpentSeconds / 60) + ' ph√∫t'
                    : 'N/A';
                const progress = enrollment && enrollment.progressPercent 
                    ? enrollment.progressPercent + '%'
                    : '100%';
                
                return `
                    <div class="course-card">
                        <div class="course-header">
                            <div>
                                <h3 class="course-title">${course.name || 'Kh√≥a h·ªçc'}</h3>
                                <p style="color: #6c757d; margin-top: 8px;">${course.description || ''}</p>
                            </div>
                            <span class="course-badge badge-completed">‚úì Ho√†n th√†nh</span>
                        </div>
                        <div class="course-details">
                            <div class="detail-item">
                                <span class="detail-label">ƒêi·ªÉm s·ªë</span>
                                <span class="detail-value">${course.score || 0}/100</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">X·∫øp lo·∫°i</span>
                                <span class="detail-value grade-${course.grade || 'D'}">${course.grade || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Th·ªùi gian h·ªçc</span>
                                <span class="detail-value">${timeSpent}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ti·∫øn ƒë·ªô</span>
                                <span class="detail-value">${progress}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ƒê·ªëi t√°c c·∫•p</span>
                                <span class="detail-value">${course.issuer || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ng√†y ho√†n th√†nh</span>
                                <span class="detail-value">${new Date(course.issueDate || course.createdAt).toLocaleDateString('vi-VN')}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            debugLog('‚úÖ All courses displayed successfully');
        }
        
        // ===== INITIALIZE =====
        window.addEventListener('DOMContentLoaded', () => {
            debugLog('=== üåü PAGE LOADED ===');
            debugLog(`Student ID: ${studentId}`);
            debugLog(`Backend URL: ${BACKEND_URL}`);
            loadCompletedCourses();
        });
    </script>
</body>
</html>
