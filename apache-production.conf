# ========================================================
# Apache Configuration for EduWallet + Partner Demos
# Ubuntu + Apache2
#
# Install: sudo apt install apache2
# Enable modules: sudo a2enmod proxy proxy_http ssl rewrite headers
# ========================================================

# ==========================================
# EduWallet Main Application (Frontend)
# Domain: eduwallet.mojistudio.vn
# Static files served from /www/wwwroot/eduwallet.mojistudio.vn
# ==========================================

<VirtualHost *:80>
    ServerName eduwallet.mojistudio.vn

    # Document Root - React Build
    DocumentRoot /www/wwwroot/eduwallet.mojistudio.vn

    <Directory /www/wwwroot/eduwallet.mojistudio.vn>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # React Router - SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Cache static assets
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api-eduwallet.mojistudio.vn wss://api-eduwallet.mojistudio.vn https://api.pinata.cloud; frame-src 'none';"

    # Logs
    ErrorLog /www/wwwlogs/eduwallet_error.log
    CustomLog /www/wwwlogs/eduwallet_access.log combined
</VirtualHost>

# ==========================================
# EduWallet Backend API
# Domain: api-eduwallet.mojistudio.vn
# Proxy to Node.js on Port 3001
# ==========================================

<VirtualHost *:80>
    ServerName api-eduwallet.mojistudio.vn

    # Redirect to HTTPS
    Redirect permanent / https://api-eduwallet.mojistudio.vn/
</VirtualHost>

<VirtualHost *:443>
    ServerName api-eduwallet.mojistudio.vn

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api-eduwallet.mojistudio.vn/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api-eduwallet.mojistudio.vn/privkey.pem

    # Proxy to Node.js Backend
    ProxyPreserveHost On
    ProxyPass / http://localhost:3005/
    ProxyPassReverse / http://localhost:3005/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3005/$1 [P,L]

    # Health check
    <Location /health>
        ProxyPass http://localhost:3005/health
        ProxyPassReverse http://localhost:3005/health
    </Location>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/api-eduwallet_error.log
    CustomLog ${APACHE_LOG_DIR}/api-eduwallet_access.log combined
</VirtualHost>

# ==========================================
# Partner 1 - Video Learning Platform
# Domain: partner1.mojistudio.vn
# Proxy to Node.js on Port 6000
# ==========================================

<VirtualHost *:80>
    ServerName partner1.mojistudio.vn
    Redirect permanent / https://partner1.mojistudio.vn/
</VirtualHost>

<VirtualHost *:443>
    ServerName partner1.mojistudio.vn

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/partner1.mojistudio.vn/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/partner1.mojistudio.vn/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://localhost:6000/
    ProxyPassReverse / http://localhost:6000/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:6000/$1 [P,L]

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    <Location /health>
        ProxyPass http://localhost:6000/health
        ProxyPassReverse http://localhost:6000/health
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/partner1_error.log
    CustomLog ${APACHE_LOG_DIR}/partner1_access.log combined
</VirtualHost>

# ==========================================
# Partner 2 - Quiz Platform
# Domain: partner2.mojistudio.vn
# Proxy to Node.js on Port 3003
# ==========================================

<VirtualHost *:80>
    ServerName partner2.mojistudio.vn
    Redirect permanent / https://partner2.mojistudio.vn/
</VirtualHost>

<VirtualHost *:443>
    ServerName partner2.mojistudio.vn

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/partner2.mojistudio.vn/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/partner2.mojistudio.vn/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://localhost:3003/
    ProxyPassReverse / http://localhost:3003/

    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3003/$1 [P,L]

    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    <Location /health>
        ProxyPass http://localhost:3003/health
        ProxyPassReverse http://localhost:3003/health
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/partner2_error.log
    CustomLog ${APACHE_LOG_DIR}/partner2_access.log combined
</VirtualHost>

# ==========================================
# Partner 3 - Hybrid Platform
# Domain: partner3.mojistudio.vn
# Proxy to Node.js on Port 3004
# ==========================================

<VirtualHost *:80>
    ServerName partner3.mojistudio.vn
    Redirect permanent / https://partner3.mojistudio.vn/
</VirtualHost>

<VirtualHost *:443>
    ServerName partner3.mojistudio.vn

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/partner3.mojistudio.vn/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/partner3.mojistudio.vn/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://localhost:3004/
    ProxyPassReverse / http://localhost:3004/

    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3004/$1 [P,L]

    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    <Location /health>
        ProxyPass http://localhost:3004/health
        ProxyPassReverse http://localhost:3004/health
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/partner3_error.log
    CustomLog ${APACHE_LOG_DIR}/partner3_access.log combined
</VirtualHost>

# SSL Configuration
SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite HIGH:!aNULL:!MD5
SSLHonorCipherOrder on
